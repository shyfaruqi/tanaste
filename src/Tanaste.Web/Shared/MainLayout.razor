@namespace Tanaste.Web.Shared
@inherits LayoutComponentBase
@inject ThemeService ThemeService
@implements IDisposable

<MudThemeProvider Theme="@ThemeService.Theme" IsDarkMode="@_isDark" />
<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider />

@* Global Command Palette — mounted at layout level so it floats above all page content *@
<CommandPalette @ref="_palette" />

<MudLayout>
    <MudAppBar Elevation="2">
        <MudIconButton Icon="@Icons.Material.Filled.Menu"
                       Color="Color.Inherit"
                       Edge="Edge.Start"
                       OnClick="@ToggleDrawer"
                       title="Toggle navigation" />

        <MudLink Href="/" Underline="Underline.None" Class="ml-2 d-flex align-center">
            <img src="images/tanaste-logo.svg" alt="Tanaste" class="tanaste-logo" style="height: 34px; display: block;" />
        </MudLink>

        <MudSpacer />

        @* Search button — Ctrl+K shortcut hint *@
        <MudTooltip Text="Search (Ctrl+K)" Arrow="true" Placement="Placement.Bottom">
            <MudIconButton Icon="@Icons.Material.Filled.Search"
                           Color="Color.Inherit"
                           OnClick="@(() => _palette?.Toggle())"
                           title="Search (Ctrl+K)" />
        </MudTooltip>

        <MudIconButton Icon="@(_isDark ? Icons.Material.Filled.LightMode : Icons.Material.Filled.DarkMode)"
                       Color="Color.Inherit"
                       OnClick="@ToggleTheme"
                       title="@(_isDark ? "Switch to Light Mode" : "Switch to Dark Mode")" />
    </MudAppBar>

    <MudDrawer Open="_drawerOpen"
               OpenChanged="@((v) => _drawerOpen = v)"
               Elevation="1"
               ClipMode="DrawerClipMode.Always"
               Variant="DrawerVariant.Persistent">
        <NavMenu />
    </MudDrawer>

    <MudMainContent Class="pt-16 pa-4">
        <MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
            @Body
        </MudContainer>
    </MudMainContent>
</MudLayout>

@code {
    private bool _isDark     = true;
    private bool _drawerOpen = true;

    private CommandPalette? _palette;

    protected override void OnInitialized()
    {
        _isDark = ThemeService.IsDarkMode;
        ThemeService.OnThemeChanged += OnThemeUpdated;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Register Ctrl+K to open the Command Palette.
            await JS.InvokeVoidAsync("registerCtrlK", DotNetObjectReference.Create(this));
            // Seed the body class so logos render correctly before any toggle.
            await JS.InvokeVoidAsync("setThemeClass", _isDark);
        }
    }

    [JSInvokable]
    public void OpenPalette() => _palette?.Open();

    private void ToggleDrawer() => _drawerOpen = !_drawerOpen;

    private async Task ToggleTheme()
    {
        ThemeService.ToggleTheme();
        _isDark = ThemeService.IsDarkMode;
        await JS.InvokeVoidAsync("setThemeClass", _isDark);
    }

    private void OnThemeUpdated()
    {
        _isDark = ThemeService.IsDarkMode;
        InvokeAsync(StateHasChanged);
    }

    public void Dispose() => ThemeService.OnThemeChanged -= OnThemeUpdated;

    [Inject] private IJSRuntime JS { get; set; } = default!;
}
