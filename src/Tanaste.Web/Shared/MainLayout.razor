@namespace Tanaste.Web.Shared
@inherits LayoutComponentBase
@inject ThemeService ThemeService
@inject NavigationManager Nav
@implements IDisposable

<MudThemeProvider Theme="@ThemeService.Theme" IsDarkMode="@_isDark" />
<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider />

@* Global Command Palette — mounted at layout level so it floats above all page content *@
<CommandPalette @ref="_palette" />

<MudLayout>
    @* ── Header: avatar | centered title | search + theme toggle ── *@
    <MudAppBar Elevation="0" Class="spatial-appbar">
        <MudIconButton OnClick="@(() => Nav.NavigateTo("/settings"))"
                       title="Profile & Settings"
                       Class="mr-1"
                       Style="padding: 4px;">
            <MudAvatar Size="Size.Small" Style="background: var(--tanaste-glass-inner-bg);">
                <MudIcon Icon="@Icons.Material.Filled.Person" Size="Size.Small" />
            </MudAvatar>
        </MudIconButton>

        <MudSpacer />

        <MudLink Href="/" Underline="Underline.None" Class="d-flex align-center"
                 Style="text-decoration: none;">
            <img src="images/tanaste-logo.svg" alt="Tanaste" class="tanaste-logo"
                 style="height: 32px; display: block;" />
        </MudLink>

        <MudSpacer />

        @* Search button — Ctrl+K shortcut hint *@
        <MudTooltip Text="Search (Ctrl+K)" Arrow="true" Placement="Placement.Bottom">
            <MudIconButton Icon="@Icons.Material.Filled.Search"
                           Color="Color.Inherit"
                           OnClick="@(() => _palette?.Toggle())"
                           title="Search (Ctrl+K)" />
        </MudTooltip>

        <MudIconButton Icon="@(_isDark ? Icons.Material.Filled.LightMode : Icons.Material.Filled.DarkMode)"
                       Color="Color.Inherit"
                       OnClick="@ToggleTheme"
                       title="@(_isDark ? "Switch to Light Mode" : "Switch to Dark Mode")" />
    </MudAppBar>

    @* Full-width main content — no sidebar *@
    <MudMainContent Class="pt-16 pa-4">
        <MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
            @Body
        </MudContainer>
    </MudMainContent>

    @* Floating Intent Dock — fixed at bottom centre *@
    <IntentDock />
</MudLayout>

@code {
    private bool _isDark = true;

    private CommandPalette? _palette;

    protected override void OnInitialized()
    {
        _isDark = ThemeService.IsDarkMode;
        ThemeService.OnThemeChanged += OnThemeUpdated;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Register Ctrl+K to open the Command Palette.
            await JS.InvokeVoidAsync("registerCtrlK", DotNetObjectReference.Create(this));
            // Seed the body class so logos render correctly before any toggle.
            await JS.InvokeVoidAsync("setThemeClass", _isDark);
        }
    }

    [JSInvokable]
    public void OpenPalette() => _palette?.Open();

    private async Task ToggleTheme()
    {
        ThemeService.ToggleTheme();
        _isDark = ThemeService.IsDarkMode;
        await JS.InvokeVoidAsync("setThemeClass", _isDark);
    }

    private void OnThemeUpdated()
    {
        _isDark = ThemeService.IsDarkMode;
        InvokeAsync(StateHasChanged);
    }

    public void Dispose() => ThemeService.OnThemeChanged -= OnThemeUpdated;

    [Inject] private IJSRuntime JS { get; set; } = default!;
}
