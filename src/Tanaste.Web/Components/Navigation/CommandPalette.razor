@namespace Tanaste.Web.Components.Navigation
@inject NavigationManager Nav
@inject UIOrchestratorService Orchestrator

@* Global Command Palette — keyboard-driven navigation and live search (Section 2.2 of the UI ASD).
   Toggled with Ctrl+K.  Uses MudAutocomplete so results appear as the user types,
   calling GET /hubs/search for queries ≥ 2 characters and falling back to
   static navigation links for empty / short queries.                               *@

@if (_open)
{
    <MudOverlay Visible="true" OnClick="@Close" DarkBackground="true" ZIndex="1300" />

    <MudPaper Class="command-palette mud-elevation-24"
              Style="position: fixed; top: 15vh; left: 50%; transform: translateX(-50%);
                     width: min(640px, 90vw); z-index: 1400; overflow: visible;">

        <MudAutocomplete T="PaletteItem"
                         @ref="_autocomplete"
                         Placeholder="Search hubs, navigate…"
                         SearchFunc="@SearchAsync"
                         ValueChanged="@OnItemSelected"
                         ToStringFunc="@(i => i?.Label ?? string.Empty)"
                         Variant="Variant.Filled"
                         Adornment="Adornment.Start"
                         AdornmentIcon="@Icons.Material.Filled.Search"
                         Underline="false"
                         Dense="true"
                         ResetValueOnEmptyText="true"
                         CoerceText="false"
                         CoerceValue="false"
                         MaxItems="20"
                         Class="pa-2"
                         Style="font-size: 1.1rem;">
            <ItemTemplate Context="item">
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="py-1">
                    <MudIcon Icon="@item.Icon"
                             Style="@($"color: {item.Color}; font-size: 20px; min-width: 20px;")" />
                    <div>
                        <MudText Typo="Typo.body2">@item.Label</MudText>
                        @if (!string.IsNullOrEmpty(item.Subtitle))
                        {
                            <MudText Typo="Typo.caption" Color="Color.Secondary">@item.Subtitle</MudText>
                        }
                    </div>
                </MudStack>
            </ItemTemplate>
        </MudAutocomplete>

        <MudDivider />
        <MudText Typo="Typo.caption" Color="Color.Secondary" Class="pa-2 d-block">
            ↑↓ navigate &nbsp;·&nbsp; Enter select &nbsp;·&nbsp; Esc close
        </MudText>
    </MudPaper>
}

@code {
    private bool _open = false;
    private MudAutocomplete<PaletteItem>? _autocomplete;

    // ── Static navigation items ───────────────────────────────────────────────

    private static readonly PaletteItem[] StaticItems =
    [
        new("Library",         "/",                Icons.Material.Filled.LibraryBooks,       "#7C4DFF", null),
        new("Preferences",     "/preferences",     Icons.Material.Filled.Tune,               "#9E9E9E", "Personal settings"),
        new("Server Settings", "/server-settings", Icons.Material.Filled.AdminPanelSettings, "#9E9E9E", "Library, metadata, API keys"),
    ];

    // ── Search ────────────────────────────────────────────────────────────────

    private async Task<IEnumerable<PaletteItem>> SearchAsync(
        string value,
        CancellationToken ct)
    {
        // Empty / too-short query → return static nav links.
        if (string.IsNullOrWhiteSpace(value) || value.Trim().Length < 2)
            return StaticItems;

        var results = await Orchestrator.SearchWorksAsync(value.Trim(), ct);

        if (results.Count == 0)
            return StaticItems.Where(i =>
                i.Label.Contains(value, StringComparison.OrdinalIgnoreCase));

        return results.Select(r => new PaletteItem(
            Label:    r.Title,
            Href:     $"/hub/{r.HubId}",
            Icon:     MediaIcon(r.MediaType),
            Color:    MediaColor(r.MediaType),
            Subtitle: BuildSubtitle(r)));
    }

    private void OnItemSelected(PaletteItem? item)
    {
        if (item is null) return;
        Close();
        Nav.NavigateTo(item.Href);
    }

    // ── Public surface ────────────────────────────────────────────────────────

    public void Open()
    {
        _open = true;
        StateHasChanged();
        // MudAutocomplete focuses itself when rendered.
    }

    public void Close()
    {
        _open = false;
        StateHasChanged();
    }

    public void Toggle() { if (_open) Close(); else Open(); }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (_open && _autocomplete is not null)
            await _autocomplete.FocusAsync();
    }

    // ── Private helpers ───────────────────────────────────────────────────────

    private static string MediaIcon(string mediaType) =>
        UniverseMapper.ClassifyBucketPublic(mediaType) switch
        {
            MediaTypeBucket.Book    => Icons.Material.Filled.MenuBook,
            MediaTypeBucket.Video   => Icons.Material.Filled.VideoFile,
            MediaTypeBucket.Comic   => Icons.Material.Filled.AutoStories,
            MediaTypeBucket.Audio   => Icons.Material.Filled.Headphones,
            _                      => Icons.Material.Filled.Folder,
        };

    private static string MediaColor(string mediaType) =>
        UniverseMapper.ClassifyBucketPublic(mediaType) switch
        {
            MediaTypeBucket.Book    => "#FF8F00",
            MediaTypeBucket.Video   => "#00BFA5",
            MediaTypeBucket.Comic   => "#7C4DFF",
            MediaTypeBucket.Audio   => "#EC407A",
            _                      => "#9E9E9E",
        };

    private static string BuildSubtitle(SearchResultViewModel r)
    {
        var parts = new List<string>();
        if (!string.IsNullOrEmpty(r.Author)) parts.Add(r.Author);
        if (!string.IsNullOrEmpty(r.HubDisplayName)) parts.Add($"in {r.HubDisplayName}");
        return string.Join(" · ", parts);
    }

    private sealed record PaletteItem(
        string  Label,
        string  Href,
        string  Icon,
        string  Color,
        string? Subtitle);
}

<style>
    .command-palette {
        border-radius: 32px !important;
        border: 1px solid rgba(124, 77, 255, 0.30);
        background: var(--tanaste-glass-bg) !important;
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
    }
</style>
