@namespace Tanaste.Web.Components.Navigation
@inject NavigationManager Nav

@* Global Command Palette — keyboard-driven navigation (Section 2.2 of the UI ASD).
   Toggled with Ctrl+K. Searches hubs and navigation links. *@

@if (_open)
{
    <MudOverlay Visible="true" OnClick="@Close" DarkBackground="true" ZIndex="1300" />

    <MudPaper Class="command-palette mud-elevation-24"
              Style="position: fixed; top: 15vh; left: 50%; transform: translateX(-50%);
                     width: min(640px, 90vw); z-index: 1400; overflow: hidden;">

        <MudTextField @ref="_inputRef"
                      @bind-Value="_query"
                      Placeholder="Search hubs, navigate…"
                      Variant="Variant.Filled"
                      Adornment="Adornment.Start"
                      AdornmentIcon="@Icons.Material.Filled.Search"
                      Underline="false"
                      Class="pa-2"
                      Style="font-size: 1.1rem;"
                      @oninput="OnInput" />

        <MudDivider />

        <MudList T="string" Class="py-1" Style="max-height: 340px; overflow-y: auto;">
            @foreach (var item in FilteredItems)
            {
                <MudListItem T="string"
                             Icon="@item.Icon"
                             OnClick="@(() => Navigate(item.Href))">
                    @item.Label
                </MudListItem>
            }

            @if (!FilteredItems.Any())
            {
                <MudListItem T="string" Icon="@Icons.Material.Filled.SearchOff" Disabled="true">
                    No results for "@_query"
                </MudListItem>
            }
        </MudList>

        <MudDivider />
        <MudText Typo="Typo.caption" Color="Color.Secondary" Class="pa-2 d-block">
            ↑↓ navigate &nbsp;·&nbsp; Enter select &nbsp;·&nbsp; Esc close
        </MudText>
    </MudPaper>
}

@code {
    /// <summary>Hubs passed in from the parent layout / Home page for search.</summary>
    [Parameter] public List<HubViewModel> Hubs { get; set; } = [];

    private bool          _open     = false;
    private string        _query    = string.Empty;
    private MudTextField<string>? _inputRef;

    private static readonly PaletteItem[] StaticItems =
    [
        new("Library",   "/",          Icons.Material.Filled.LibraryBooks),
        new("Ingestion", "/ingestion", Icons.Material.Filled.FolderOpen),
        new("Metadata",  "/metadata",  Icons.Material.Filled.Tune),
        new("Admin",     "/admin",     Icons.Material.Filled.AdminPanelSettings),
    ];

    private IEnumerable<PaletteItem> FilteredItems =>
        StaticItems
            .Concat(Hubs.Select(h => new PaletteItem(h.DisplayName, $"/hub/{h.Id}", Icons.Material.Filled.Folder)))
            .Where(i => string.IsNullOrWhiteSpace(_query) ||
                        i.Label.Contains(_query, StringComparison.OrdinalIgnoreCase));

    public void Open()
    {
        _open  = true;
        _query = string.Empty;
        // Focus is set in OnAfterRender
        StateHasChanged();
    }

    public void Close()
    {
        _open = false;
        StateHasChanged();
    }

    public void Toggle() { if (_open) Close(); else Open(); }

    private void OnInput(ChangeEventArgs e) => _query = e.Value?.ToString() ?? string.Empty;

    private void Navigate(string href)
    {
        Close();
        Nav.NavigateTo(href);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (_open && _inputRef is not null)
            await _inputRef.FocusAsync();
    }

    private sealed record PaletteItem(string Label, string Href, string Icon);
}

<style>
    .command-palette {
        border-radius: 24px !important;
        border: 1px solid rgba(124, 77, 255, 0.40);
    }
</style>
