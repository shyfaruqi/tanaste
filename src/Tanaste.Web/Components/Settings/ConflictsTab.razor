@namespace Tanaste.Web.Components.Settings
@inject UIOrchestratorService Orchestrator

@* Conflicts — surfaces metadata fields where the Weighted Voter could not pick a
   clear winner. Each row lets a Curator resolve the conflict via the lock-claim endpoint.
   Spec: Phase B – Conflict Surfacing (B-05). *@

<MudPaper Elevation="0" Style="@GlassStyle">

    <MudStack Row="true" AlignItems="AlignItems.Center" Class="mb-4">
        <MudIcon Icon="@Icons.Material.Filled.Warning" Color="Color.Warning" Class="mr-2" />
        <MudText Typo="Typo.h6">Metadata Conflicts</MudText>
        @if (_conflicts.Count > 0)
        {
            <MudBadge Content="@_conflicts.Count" Color="Color.Warning" Overlap="false" Class="ml-2" />
        }
    </MudStack>

    <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-4">
        These metadata fields have competing values from different sources that scored too
        close to pick a clear winner. Choose the correct value to resolve each conflict.
    </MudText>

    @if (_loading)
    {
        <MudProgressLinear Indeterminate="true" Color="Color.Primary" Class="mb-2" />
    }
    else if (_conflicts.Count == 0)
    {
        <MudAlert Severity="Severity.Success" Class="mt-2">
            No metadata conflicts detected. All fields have clear winners.
        </MudAlert>
    }
    else
    {
        <MudTable Items="@_conflicts" Dense="true" Hover="true" Breakpoint="Breakpoint.Sm"
                  Style="background: transparent;">
            <HeaderContent>
                <MudTh>Entity</MudTh>
                <MudTh>Field</MudTh>
                <MudTh>Current Value</MudTh>
                <MudTh>Last Scored</MudTh>
                <MudTh Style="text-align:right">Action</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd>
                    <code style="font-family: monospace; font-size: 0.8rem;
                                  background: rgba(0,0,0,0.2); padding: 2px 6px;
                                  border-radius: 4px;">
                        @context.EntityId.ToString()[..8]…
                    </code>
                </MudTd>
                <MudTd>
                    <MudChip T="string" Size="Size.Small" Color="Color.Warning" Variant="Variant.Outlined">
                        @context.Key
                    </MudChip>
                </MudTd>
                <MudTd>@context.Value</MudTd>
                <MudTd>@context.LastScoredAt.LocalDateTime.ToString("g")</MudTd>
                <MudTd Style="text-align:right">
                    <MudButton Variant="Variant.Text"
                               Size="Size.Small"
                               Color="Color.Primary"
                               StartIcon="@Icons.Material.Filled.Edit"
                               OnClick="@(() => OnResolveClicked.InvokeAsync((context.EntityId, context.Key)))">
                        Resolve
                    </MudButton>
                </MudTd>
            </RowTemplate>
        </MudTable>
    }

</MudPaper>

@code {
    /// <summary>
    /// Callback to parent (ServerSettings) to open the Curator's Drawer for
    /// the selected entity.
    /// </summary>
    [Parameter] public EventCallback<(Guid EntityId, string Key)> OnResolveClicked { get; set; }

    private List<Tanaste.Web.Models.ViewDTOs.ConflictViewModel> _conflicts = [];
    private bool _loading = true;

    protected override async Task OnInitializedAsync()
    {
        _loading = true;
        try
        {
            _conflicts = await Orchestrator.GetConflictsAsync();
        }
        finally
        {
            _loading = false;
        }
    }

    /// <summary>Number of active conflicts (exposed for parent badge display).</summary>
    public int ConflictCount => _conflicts.Count;

    private const string GlassStyle =
        "background: var(--tanaste-glass-bg); " +
        "border: 1px solid var(--tanaste-glass-border); " +
        "backdrop-filter: blur(10px); " +
        "-webkit-backdrop-filter: blur(10px); " +
        "border-radius: 32px; " +
        "padding: 32px;";
}
