@namespace Tanaste.Web.Components.Settings
@inject UIOrchestratorService Orchestrator
@inject ISnackbar Snackbar

@* Metadata Providers — enriched view with domain, capability tags,
   trust weights, live reachability status, and enable/disable toggle. *@

<MudPaper Elevation="0" Style="@GlassStyle">

    <MudStack Row="true" AlignItems="AlignItems.Center" Class="mb-2">
        <MudIcon Icon="@Icons.Material.Outlined.Cloud" Color="Color.Primary" Class="mr-2" />
        <MudText Typo="Typo.h6">Metadata Providers</MudText>
    </MudStack>
    <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-4">
        These are the sources used to enrich your library. Each provider contributes
        metadata with a per-field trust weight — higher weights win in scoring conflicts.
        Toggle a provider on or off to control which sources are active.
    </MudText>

    @if (_loading)
    {
        <MudProgressLinear Indeterminate="true" Color="Color.Primary" />
    }
    else if (_engineDown)
    {
        <MudAlert Severity="Severity.Error" Class="mt-2">
            Cannot reach the Engine — please make sure it is running. Provider status
            will appear once the connection is restored.
        </MudAlert>
    }
    else if (_providers.Count == 0)
    {
        <MudAlert Severity="@(_errorDetail is not null ? Severity.Error : Severity.Info)">
            @if (_errorDetail is not null)
            {
                <span>Could not load providers: @_errorDetail</span>
            }
            else
            {
                <span>No providers are configured. Add provider entries to your manifest to see status here.</span>
            }
        </MudAlert>
    }
    else
    {
        @foreach (var p in _providers)
        {
            <MudPaper Elevation="0" Style="@InnerCardStyle" Class="mb-3">

                @* Row 1: Status dot + Name + Domain badge + Toggle + Reachability *@
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="mb-2">
                    <MudIcon Icon="@Icons.Material.Filled.Circle"
                             Color="@(p.IsReachable ? Color.Success : (p.Enabled ? Color.Error : Color.Default))"
                             Size="Size.Small" />
                    <MudText Typo="Typo.subtitle1" Style="flex: 1; min-width: 0; font-weight: 600;">
                        @p.DisplayName
                    </MudText>

                    @if (!string.IsNullOrEmpty(p.Domain))
                    {
                        <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined"
                                 Color="Color.Info">
                            @p.Domain
                        </MudChip>
                    }

                    @if (p.IsZeroKey)
                    {
                        <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined"
                                 Color="Color.Warning">
                            Zero-key
                        </MudChip>
                    }

                    <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined"
                             Color="@(p.Enabled ? (p.IsReachable ? Color.Success : Color.Error) : Color.Default)">
                        @(p.Enabled ? (p.IsReachable ? "Reachable" : "Unreachable") : "Disabled")
                    </MudChip>

                    <MudSwitch T="bool"
                               Value="@p.Enabled"
                               ValueChanged="@(v => ToggleProviderAsync(p.Name, v))"
                               Color="Color.Primary"
                               Disabled="@_toggling" />
                </MudStack>

                @* Row 2: Capability tags *@
                @if (p.CapabilityTags is { Count: > 0 })
                {
                    <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center"
                              Class="mb-2" Style="flex-wrap: wrap;">
                        <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mr-1">
                            Expert in:
                        </MudText>
                        @foreach (var tag in p.CapabilityTags)
                        {
                            <MudChip T="string" Size="Size.Small" Color="Color.Primary"
                                     Variant="Variant.Text">
                                @tag
                            </MudChip>
                        }
                    </MudStack>
                }

                @* Row 3: Trust weight *@
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="mb-1">
                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                        Default Trust:
                    </MudText>
                    <MudText Typo="Typo.caption" Style="font-weight: 600;">
                        @((p.DefaultWeight * 100).ToString("F0"))%
                    </MudText>
                </MudStack>

                @* Row 4: Per-field weights *@
                @if (p.FieldWeights is { Count: > 0 })
                {
                    <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mb-1">
                        Field-specific trust:
                    </MudText>
                    <MudStack Row="true" Spacing="1" Style="flex-wrap: wrap;">
                        @foreach (var fw in p.FieldWeights.OrderByDescending(kv => kv.Value))
                        {
                            <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined">
                                @fw.Key: @((fw.Value * 100).ToString("F0"))%
                            </MudChip>
                        }
                    </MudStack>
                }

            </MudPaper>
        }
    }

</MudPaper>

@code {

    private const string GlassStyle =
        "background: var(--tanaste-glass-bg); " +
        "border: 1px solid var(--tanaste-glass-border); " +
        "backdrop-filter: blur(10px); " +
        "-webkit-backdrop-filter: blur(10px); " +
        "border-radius: 32px; " +
        "padding: 32px;";

    private const string InnerCardStyle =
        "background: var(--tanaste-glass-inner-bg); " +
        "border: 1px solid var(--tanaste-glass-inner-border); " +
        "border-radius: 16px; " +
        "padding: 20px;";

    // ── State ────────────────────────────────────────────────────────────────────

    private bool                             _loading    = true;
    private bool                             _engineDown;
    private bool                             _toggling;
    private string?                          _errorDetail;
    private IReadOnlyList<ProviderStatusDto> _providers  = [];

    // ── Lifecycle ────────────────────────────────────────────────────────────────

    protected override async Task OnInitializedAsync()
    {
        await LoadProvidersAsync();
    }

    // ── Handlers ─────────────────────────────────────────────────────────────────

    private async Task LoadProvidersAsync()
    {
        _loading    = true;
        _engineDown = false;
        _errorDetail = null;

        // Pre-flight: verify the Engine is reachable.
        var status = await Orchestrator.GetSystemStatusAsync();
        if (status is null)
        {
            _engineDown = true;
            _loading    = false;
            return;
        }

        _providers = await Orchestrator.GetProviderStatusAsync();

        // If the Engine is reachable but returned zero providers, check for errors.
        if (_providers.Count == 0)
        {
            _errorDetail = Orchestrator.LastApiError;
        }

        _loading = false;
    }

    private async Task ToggleProviderAsync(string name, bool enabled)
    {
        _toggling = true;
        var ok = await Orchestrator.UpdateProviderAsync(name, enabled);

        if (ok)
        {
            Snackbar.Add(
                enabled ? $"Provider enabled" : $"Provider disabled",
                enabled ? Severity.Success : Severity.Info);
            // Refresh the full list to get updated reachability.
            _providers = await Orchestrator.GetProviderStatusAsync();
        }
        else
        {
            Snackbar.Add("Could not update provider — please make sure the Engine is running.",
                Severity.Error);
        }

        _toggling = false;
    }
}
