@page "/"
@inject UIOrchestratorService  Orchestrator
@inject ThemeService            ThemeService
@inject UniverseStateContainer  State
@implements IDisposable

<PageTitle>Tanaste — Last Journey</PageTitle>

@if (_loading)
{
    <MudProgressLinear Indeterminate="true" Color="Color.Primary" Class="mb-4"
                       Style="border-radius: 8px;" />
}
else if (_error is not null)
{
    <MudAlert Severity="Severity.Error" Class="mb-4">@_error</MudAlert>
}
else
{
    @* ── Pending files alert (Watch Folder) ── *@
    <PendingFilesAlert Class="mb-4" />

    @* ── Last Journey section header ── *@
    <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="mb-4">
        <MudText Typo="Typo.h5" Style="font-weight: 600;">Last Journey</MudText>

        @* View mode toggle — visual only; Compact List wiring is a future enhancement *@
        <MudToggleGroup T="string" @bind-Value="_viewMode"
                        Style="border-radius: 20px; overflow: hidden;"
                        Color="Color.Primary" CheckMark="false">
            <MudToggleItem T="string" Value="@("grid")" Text="Comfortable Grid" />
            <MudToggleItem T="string" Value="@("list")" Text="Compact List" />
        </MudToggleGroup>
    </MudStack>

    @* ── Hero tile ── *@
    <HubHero Hub="@_heroHub" />

    @* ── Your Universes grid (non-hero hubs) ── *@
    <UniverseStack Hubs="@_nonHeroHubs" Class="mt-2" OnHubSelected="HandleHubSelected" />
}

@code {
    private bool               _loading = true;
    private string?            _error;
    private HubViewModel?      _heroHub;
    private List<HubViewModel> _hubs = [];
    private List<HubViewModel> _nonHeroHubs = [];
    private string             _viewMode = "grid";

    protected override async Task OnInitializedAsync()
    {
        // Subscribe before loading so no MediaAdded event is missed.
        State.OnStateChanged += OnStateChanged;

        // Start the SignalR Intercom channel (idempotent; non-fatal on failure).
        await Orchestrator.StartSignalRAsync();

        await LoadHubsAsync(showSpinner: true);
    }

    // ── Hub loading ───────────────────────────────────────────────────────────

    private async Task LoadHubsAsync(bool showSpinner = true)
    {
        if (showSpinner)
            _loading = true;

        _error = null;

        try
        {
            _hubs    = await Orchestrator.GetHubsAsync();
            _heroHub = _hubs.FirstOrDefault();

            // Non-hero hubs: skip the first one (shown in HubHero).
            _nonHeroHubs = _hubs.Count > 1 ? _hubs.Skip(1).ToList() : [];

            // Prime the accent colour from the hero hub so the app bar and
            // primary-coloured MudBlazor components match on first load.
            if (_heroHub is not null)
                ThemeService.SetHubAccent(_heroHub.DominantHexColor);
        }
        catch (Exception ex)
        {
            _error = $"Could not reach Tanaste API: {ex.Message}";
        }
        finally
        {
            _loading = false;
        }
    }

    // ── Hub selection ─────────────────────────────────────────────────────────

    /// <summary>
    /// Called by <see cref="UniverseStack"/> when the user clicks a Hub tile.
    /// Shifts the MudThemeProvider primary accent to that Hub's brand colour
    /// and promotes the selected hub to the hero position.
    /// </summary>
    private void HandleHubSelected(HubViewModel hub)
    {
        ThemeService.SetHubAccent(hub.DominantHexColor);
        _heroHub     = hub;
        _nonHeroHubs = _hubs.Where(h => h.Id != hub.Id).ToList();
    }

    // ── SignalR live refresh ──────────────────────────────────────────────────

    private void OnStateChanged()
    {
        InvokeAsync(async () =>
        {
            await LoadHubsAsync(showSpinner: false);
            StateHasChanged();
        });
    }

    public void Dispose()
    {
        State.OnStateChanged -= OnStateChanged;
    }
}
